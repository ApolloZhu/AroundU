# Backend

### File structure

- Data Access Object (DAO): model database entities
    1. `Event.java`
        1. Data representation of an Event
    2. `EventParticipants.java`
        1. Data representation of all participants in an Event
    3. `User.java`
        1. Data representation of a User
    4. `UserParticipates.java`
        1. Data representation of all events a User is in
- Data Transfer Object (DTO): model HTTP request and response entities
    1. `DataResponse.java`
        1. Carries data (code, message, data object) between processes
    2. `OperationResponse.java`
        1. Carries operational data (code, message) between processes
- Data Access Layer (DAL): controls data access from database
    1. `EventController.java`
        1. Manages the Event database operations such as insertion, selection or deletion.
    2. `UserController.java`
        1. Manages the User database operations such as insertion, selection or deletion.
    3. `ParticipateController.java`
        1. Manages the Participate database operations such as insertion, selection or deletion.
- Others:
    1. `SparkServer.java`
        1. Manages all APIs, connection to the database and parsing token from firebase.
    2. `CloudSqlConnectionPool.java`
        1. Generates the datasource connection pool according to the authentication info given.
    3. `CloudKmsEnvelopeAead.java`
        1. Initialize an envelope AEAD primitive for data Encryption.

## Developer Instructions

### Getting Started

- Install Maven, Spark and set
  up [Cloud SQL Auth proxy](https://cloud.google.com/sql/docs/mysql/connect-instance-auth-proxy)
- [Setting up Spark Server](https://sparkjava.com/documentation#getting-started)
- [Connecting to Cloud SQL database](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/main/cloud-sql/mysql/servlet/README.md)
- Put the secret API strings into a env file in /backend. The application will need those secret strings to access
  external dependencies. Contact @John to get the secret strings.
- Make sure your GCP accout has access to the arondu-403 project.

### How to spin up the SparkServer

1. Sign in to your gcloud account. Make sure you have IAM access to the database
2. Add environment variable such as database password. Contact @John if you don't know the secret strings
3. run SparkServer

### How to deploy to GCP cloud engine

Deploy backend code by manually triggering the deployment GitHub action. We have automated the build and deploy process
by reducing variations and setting up environment variables.

### How to use Maven

1. `mvn install`
   Installs the packaged code to the local Maven repository.

2. `mvn complie`
   Compiles the source code, converts the .java files to .class and stores the classes in target/classes folder.

3. `mvn verify -Psurefire`
   Run integration tests under integration-test/java (testing the connection with database requires environment
   variables)

4. `mvn validate`
   Validates if the project structure is correct, checking if all the dependencies have been downloaded and are
   available in the local repository.

5. `mvn clean`
   Clean the files and directories generated by Maven during its build

### Test APIs using Postman

- Download [Postman](https://www.postman.com)
- make sure you started the SparkServer

#### Example

Using Postman `GET` with the example request url to see the expected json data

```
http://localhost:8080/event/id?eventid=1
```

Expected result:

```
{
    "code": 200,
    "message": "Success",
    "data": {
        "event_id": 1,
        "event_code": "EVENT1",
        "event_name": "New Student Fair",
        "description": "This is event1.",
        "host_id": "aaa111",
        "isPublic": 1,
        "isDeleted": 0,
        "location_name": "CSE1",
        "latitude": 47.65346,
        "longitude": -122.30597,
        "max_participants": 10,
        "curr_num_participants": 0,
        "photoID": "event1.jpg",
        "icon": "icon1.jpg",
        "address": "185 E Stevens Way NE, Seattle, WA 98195",
        "start_time": "2022-04-01 12:00:00.0",
        "end_time": "2022-04-02 12:00:00.0",
        "created_at": "2022-04-01 12:00:00.0"
    }
}
```

***
Using Postman `POST` with the example request url, and example request body

(You need to have a valid user token in the request header to test this. Contact @John if you need
a user token)

Example request url:
```
http://localhost:8080/event
```

Example request body:
```
{
    "event_code": "EVENT3",
    "event_name": "event3",
    "description": "This is event3.",
    "host_id": "aaa111",
    "isPublic":1,
    "isDeleted": 0,
    "location_name": "CSE2",
    "latitude":47.653157358950686, 
    "longitude":-122.30507501538806,
    "start_time": "2022-06-01 12:00:00", 
    "end_time": "2022-06-02 12:00:00",
    "max_participants": 20, 
    "curr_num_participants": 10, 
    "photoID": "event3.jpg",
    "icon": "icon3.jpg",
    "address": "University of Washington, 3800 E Stevens Way NE, Seattle, WA 98195",
    "created_at": "Apr 1, 2022, 12:00:00 PM"
}
```

Expected result:
```
{
    "code": 200,
    "message": "Success",
    "data": 4           // this can be different
}
```

### Adding new tests

Although we mainly used Postman for testing, you can still add integration-test under `src/integration-test/java` to
test out the connection with the database.
Sample unit testing is in `UserControllerIT.java`. 

Notice that these unit tests can only test
the interactions between our server and the database. If you want to test the APIs by simulating the frontend request and 
checking the backend responses, you should use Postman to test, detailed instructions above.